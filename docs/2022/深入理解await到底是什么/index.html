<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        小菠菜NVM
    </title>
    <link rel="shortcut icon" href="/favicon.ico">
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

<body>
    <header class="header">
    <div class="header-wrapper">
        <div class="blog-title">
            <a href="/" class="blog-title-link">
                小菠菜NVM
            </a>
        </div>
        <nav class="navbar">
            <div class="menu">
                
                    <div class="menu-item">
                        <a href="/archives" class="menu-item-link">
                            归档
                        </a>
                    </div>
                    
                    <div class="menu-item">
                        <a href="/tags" class="menu-item-link">
                            标签
                        </a>
                    </div>
                    
                    <div class="menu-item">
                        <a target="_blank" rel="noopener" href="https://github.com/inferno0303" class="menu-item-link">
                            GitHub
                        </a>
                    </div>
                    
            </div>
        </nav>
    </div>
</header>
    <div class="main">
        <article class="post-wrapper">
  <div class="post-title">
    <h1 class="h1-title">深入理解await到底是什么</h1>
  </div>
  <div class="post-meta">
    <span class="post-tags">
      标签：
      
        <span class="tag">
          note 
        </span>
       
    </span>
    <span class="post-time">发布日期：2022-05-25</span>
  </div>
  <div class="post-content"><h1 id="深入理解await到底是什么"><a href="#深入理解await到底是什么" class="headerlink" title="深入理解await到底是什么"></a>深入理解await到底是什么</h1><blockquote>
<p>前置知识：微任务、宏任务、Event Loop<br>推荐阅读：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6936630572936593422">https://juejin.cn/post/6936630572936593422</a></p>
</blockquote>
<h2 id="0x01-首先要了解Promise的两个重要属性"><a href="#0x01-首先要了解Promise的两个重要属性" class="headerlink" title="0x01 首先要了解Promise的两个重要属性"></a>0x01 首先要了解Promise的两个重要属性</h2><blockquote>
<p>此处引用自<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000038865350">https://segmentfault.com/a/1190000038865350</a></p>
</blockquote>
<h3 id="三个状态"><a href="#三个状态" class="headerlink" title="三个状态"></a>三个状态</h3><ul>
<li>pending 准备</li>
<li>fulfilled 成功</li>
<li>rejected 失败</li>
</ul>
<h3 id="两个过程"><a href="#两个过程" class="headerlink" title="两个过程"></a>两个过程</h3><ul>
<li>pending -&gt; fulfilled</li>
<li>pending -&gt; rejected</li>
</ul>
<h3 id="一个方法"><a href="#一个方法" class="headerlink" title="一个方法"></a>一个方法</h3><ul>
<li>then</li>
</ul>
<h3 id="Promise的数据结构"><a href="#Promise的数据结构" class="headerlink" title="Promise的数据结构"></a>Promise的数据结构</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  [[<span class="title class_">PromiseState</span>]]: <span class="string">&quot;fulfilled&quot;</span>,  <span class="comment">// 状态</span></span><br><span class="line">  [[<span class="title class_">PromiseResult</span>]]: <span class="number">1</span> <span class="comment">// resolve函数传递的参数值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x02-其次要知道async是什么"><a href="#0x02-其次要知道async是什么" class="headerlink" title="0x02 其次要知道async是什么"></a>0x02 其次要知道async是什么</h2><p>async包装的函数永远返回一个Promise对象</p>
<ul>
<li>async函数执行完语句后，就自动触发<code>resolve()</code></li>
<li>async函数内return，会将返回值装入<code>Promise数据结构</code>的<code>PromiseResult</code>属性里</li>
<li>如果async函数没有return，那么<code>PromiseResult</code>属性里会装入<code>undefined</code></li>
<li>如果async函数没有发生异常，那么<code>PromiseState</code>会变成<code>fulfilled</code></li>
<li>如果async函数体发生了异常，那么<code>PromiseState</code>会变成<code>rejected</code></li>
</ul>
<h2 id="0x03-最后再了解await干了什么"><a href="#0x03-最后再了解await干了什么" class="headerlink" title="0x03 最后再了解await干了什么"></a>0x03 最后再了解await干了什么</h2><p>它的作用如下：</p>
<blockquote>
<p>引用自文章<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000024442415">https://segmentfault.com/a/1190000024442415</a><br>await 语句期望在其右侧有一个 promise 对象。当你使用 await 语句时，javascript 会暂停 async 函数的执行，等待 promise 返回一个值，然后继续执行。</p>
</blockquote>
<p>await其实是一个语法糖，用来方便的实现 Promise 结构的封装，它必须在async内使用（为什么？文章后面会说明原因）</p>
<p>大部分初学者粗浅的理解是：</p>
<ul>
<li>await 右边的函数一定是异步函数</li>
<li>await 会阻塞当前的它所在的 async 函数执行过程，要等右边的异步函数执行完成再执行下面的代码</li>
</ul>
<p><strong>以上的理解很粗浅，而且是大约是错的</strong></p>
<p>让我们看以下例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">func1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">func2</span>() <span class="comment">// 调用一个异步函数func2()</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C++&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">func2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Java&quot;</span>)</span><br><span class="line">        <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Python&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">func1</span>()</span><br></pre></td></tr></table></figure>

<p>执行结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C</span><br><span class="line">Java</span><br><span class="line">Python</span><br><span class="line">C++</span><br></pre></td></tr></table></figure>
<p>这个输出结果符合预期，毕竟await真的有等func2做完所有事情后再向下执行<br>以上代码的<code>await</code>相当于做了这件事，等效于：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">func1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    <span class="title function_">func2</span>()</span><br><span class="line">    <span class="comment">// console.log(&quot;C++&quot;) 这句话被移动到当前Promise返回值的.then里面去了</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">func2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Java&quot;</span>)</span><br><span class="line">        <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Python&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">func1</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C++&quot;</span>) <span class="comment">// 我在这里</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C</span><br><span class="line">Java</span><br><span class="line">Python</span><br><span class="line">C++</span><br></pre></td></tr></table></figure>

<p>妙啊！</p>
<p>那么async代码相当于做了这件事，等效于：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">func1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">        <span class="title function_">func2</span>()</span><br><span class="line">        <span class="title function_">resolve</span>() <span class="comment">// 把后面的callback丢到任务队列里，此时队列里已经有一个微任务啦</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">func2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Java&quot;</span>)</span><br><span class="line">        <span class="title function_">resolve</span>() <span class="comment">// 把后面的callback丢到任务队列里，此时队列里没有微任务呢</span></span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Python&quot;</span>) <span class="comment">// 我是第一个callback</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">func1</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C++&quot;</span>) <span class="comment">// 我是第二个callback</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C</span><br><span class="line">Java</span><br><span class="line">Python</span><br><span class="line">C++</span><br></pre></td></tr></table></figure>

<p>通过这三个例子，我们一步步把async await丢了，看到了他们语法糖前原本的样子</p>
<h2 id="0x04-关于await的误区"><a href="#0x04-关于await的误区" class="headerlink" title="0x04 关于await的误区"></a>0x04 关于await的误区</h2><p>先看这个例子，**请注意fun2()**：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 微任务队列 - 深刻理解await到底干了什么</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fun1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 - 1&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">fun2</span>() <span class="comment">// 此时fun2()不返回一个Promise对象</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 - 2&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fun2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun2 - 1&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise - 1&quot;</span>)</span><br><span class="line">    <span class="title function_">resolve</span>()</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise then - 1&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">fun1</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 then&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>执行结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">promise - 1</span><br><span class="line">fun1 - 1</span><br><span class="line">fun2 - 1</span><br><span class="line">promise then - 1</span><br><span class="line">fun1 - 2</span><br><span class="line">fun1 then</span><br></pre></td></tr></table></figure>

<p>以上代码去掉了async 和 await 后是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fun1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 - 1&quot;</span>)</span><br><span class="line">        <span class="title function_">fun2</span>()</span><br><span class="line">        <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fun2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun2 - 1&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise - 1&quot;</span>)</span><br><span class="line">    <span class="title function_">resolve</span>()</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise then - 1&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">fun1</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 - 2&quot;</span>)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 then&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>剖析一下执行过程：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、先执行<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise - 1&quot;</span>)，输出</span><br><span class="line"><span class="number">2</span>、然后执行<span class="title function_">resolve</span>()，把.<span class="property">then</span>后面的<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise then - 1&quot;</span>)推到任务队列里了</span><br><span class="line"><span class="number">3</span>、然进入<span class="title function_">fun1</span>()后执行<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 - 1&quot;</span>)</span><br><span class="line"><span class="number">4</span>、接着执行fun2函数里的<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun2 - 1&quot;</span>)</span><br><span class="line"></span><br><span class="line">此时同步代码已经执行完了</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、然后执行<span class="title function_">resolve</span>()，把fun1的then的callback，也就是<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 - 2&quot;</span>)，丢到任务队列里去，推入队列后，此时队列里有<span class="number">2</span>个任务了</span><br><span class="line"><span class="number">6</span>、因为前一个<span class="title class_">Promise</span>对象的同步代码已经执行完成，触发了隐式<span class="title function_">resolve</span>()，所以将<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 then&quot;</span>) 推入队列，此时队列里有<span class="number">3</span>个任务了</span><br><span class="line"></span><br><span class="line">此时任务队列已经有<span class="number">3</span>个微任务了，遵循先入先出的队列规则</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、取出<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise then - 1&quot;</span>)</span><br><span class="line"><span class="number">8</span>、取出<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 - 2&quot;</span>)</span><br><span class="line"><span class="number">9</span>、取出<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 then&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>要了解执行过程，结合注解版更好理解：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fun1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 - 1&quot;</span>) <span class="comment">// 我第4，被执行</span></span><br><span class="line">        <span class="title function_">fun2</span>() <span class="comment">// 我第5，执行fun2函数</span></span><br><span class="line">        <span class="title function_">resolve</span>() <span class="comment">// 我第7，把fun1的then的callback丢到任务队列里去，此时队列已经有一个任务啦</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fun2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun2 - 1&quot;</span>) <span class="comment">// 我第6，被执行了</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise - 1&quot;</span>) <span class="comment">// 我第1先执行</span></span><br><span class="line">    <span class="title function_">resolve</span>() <span class="comment">// 我第2执行，把后面的callback丢到任务队列里</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise then - 1&quot;</span>) <span class="comment">// 第2后，我被丢到任务队列里去了，还没执行呢</span></span><br><span class="line">    <span class="comment">// 我第9，当前已经没有要同步执行的代码了，我被从任务队列里取出来执行啦，取出后还剩2个任务</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">fun1</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123; <span class="comment">// 第3，执行fun1函数</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 - 2&quot;</span>) <span class="comment">// 我第10，从任务队列里取出并执行，取出后任务队列还有1个任务</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fun1 then&quot;</span>) </span><br><span class="line">    <span class="comment">// 我第8，因为前一个Promise对象同步代码已经执行完成，触发了隐式resolve()，我被丢到任务队列里了，此时任务队列已经有2个任务啦</span></span><br><span class="line">    <span class="comment">// 第11，我被从任务队列里取出来执行了，取出后任务队列为空</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><p>以上的例子说明了：</p>
<ul>
<li><p><strong>await其实就是把它下面的所有代码块，移动到当前所在async函数的.then回调中了！这也回答了前文中「为什么await一定要在async函数中」的问题了</strong></p>
</li>
<li><p>还要特别记住的是，<strong>async函数执行完所有的同步语句后，会触发隐式resolve，而resolve就是把.then的callback丢到异步队列的操作</strong></p>
</li>
<li><p>其次要知道的是，<strong>Promise.then()也会返回Promise对象，这就是.then().then()链式调用的基础。</strong></p>
</li>
</ul>
<p>学而不思则罔，思而不学则殆。</p>
</div>
</article>
    </div>
    <div class="footer">
    <p>
        © Copyright 2022 <a target="_blank" rel="noopener" href="https://github.com/inferno0303/" style="text-decoration: none">inferno0303</a>
    </p>
    <p>
        Power By <a target="_blank" rel="noopener" href="https://hexo.io/" style="text-decoration: none">Hexo</a>
    </p>
</div>
</body>

</html>